name: Playwright Tests
on:
  push:
    branches: [ main, master ]
  pull_request:
jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: lts/*
    - name: Install dependencies
      run: npm ci
    - name: Install Playwright Browsers
      run: npx playwright install --with-deps --no-shell chromium
    - name: Run Playwright tests
      run: npx playwright test
      env:
        PLAYWRIGHT_CI: "true"
    # Once the s3 upload works we can probably get rid of this
    - uses: actions/upload-artifact@v4
      if: ${{ !cancelled() }}
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v5
      with:
        flags: playwright
        token: ${{ secrets.CODECOV_TOKEN }}    
    - uses: concord-consortium/s3-deploy-action/deploy-path@SDEPLOY-1-pull-request-trigger
      if: always()
      id: s3-deploy-path
    - name: Upload Playwright Report
      if: always()
      run: aws s3 sync ./playwright-report s3://models-resources/dst-codap-plugin/playwright-report/${{ steps.s3-deploy-path.outputs.deployPath }} --delete --cache-control "no-cache, max-age=0"
      env: 
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

    # This requires running on a pull_request event. It uses the info from the event to figure
    # out what PR to add/update the comment on. At some point it might be useful to update this
    # action to support push events for branches attached to PRs. That can be supported by this
    # approach https://github.com/bcgov/action-get-pr/blob/main/action.yml
    - uses: daun/playwright-report-summary@v3
      if: always()
      with:
        report-file: results.json
        report-url: https://models-resources.concord.org/dst-codap-plugin/playwright-report/${{ steps.s3-deploy-path.outputs.deployPath }}/
